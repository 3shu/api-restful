services:
    _defaults:
        autowire: true
        autoconfigure: true
        bind:
            # AWS Configuration
            string $awsRegion: '%env(AWS_REGION)%'
            string $awsAccessKeyId: '%env(AWS_ACCESS_KEY_ID)%'
            string $awsSecretAccessKey: '%env(AWS_SECRET_ACCESS_KEY)%'
            bool $useAwsSecrets: '%env(bool:USE_AWS_SECRETS)%'
            
            # Redis Configuration
            string $redisHost: '%env(REDIS_HOST)%'
            int $redisPort: '%env(int:REDIS_PORT)%'

    # Make classes in src/ available for dependency injection
    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Kernel.php'
            - '../src/**/Entity/'
            - '../src/**/ValueObject/'

    # Redis Client for Secrets Cache
    Predis\Client:
        arguments:
            - scheme: tcp
              host: '%env(REDIS_HOST)%'
              port: '%env(int:REDIS_PORT)%'
              database: 0

    # AWS Secrets Manager Service
    App\Shared\Infrastructure\AWS\SecretsManagerService:
        arguments:
            $awsRegion: '%env(AWS_REGION)%'
            $awsAccessKeyId: '%env(AWS_ACCESS_KEY_ID)%'
            $awsSecretAccessKey: '%env(AWS_SECRET_ACCESS_KEY)%'
            $cache: '@App\Shared\Infrastructure\AWS\SecretsCache'
            $logger: '@logger'
            $useAwsSecrets: '%env(bool:USE_AWS_SECRETS)%'

    # Connection Manager with local configurations
    App\Shared\Infrastructure\Database\ConnectionManager:
        arguments:
            $factory: '@App\Shared\Infrastructure\Database\ConnectionFactory'
            $secretsManager: '@App\Shared\Infrastructure\AWS\SecretsManagerService'
            $logger: '@logger'
            $useAwsSecrets: '%env(bool:USE_AWS_SECRETS)%'
        calls:
            # Register local MySQL configuration (fallback)
            - registerLocalConfiguration:
                - 'api-restful/mysql_users'
                - driver: 'mysql'
                  host: '%env(MYSQL_HOST)%'
                  port: '%env(int:MYSQL_PORT)%'
                  database: '%env(MYSQL_DATABASE)%'
                  user: '%env(MYSQL_USER)%'
                  password: '%env(MYSQL_PASSWORD)%'
                  charset: 'utf8mb4'
            
            # Register local PostgreSQL configuration (fallback)
            - registerLocalConfiguration:
                - 'api-restful/postgres_books'
                - driver: 'postgres'
                  host: '%env(POSTGRES_HOST)%'
                  port: '%env(int:POSTGRES_PORT)%'
                  database: '%env(POSTGRES_DATABASE)%'
                  user: '%env(POSTGRES_USER)%'
                  password: '%env(POSTGRES_PASSWORD)%'

    # Alias for easier access
    connection_manager:
        alias: App\Shared\Infrastructure\Database\ConnectionManager
        public: true

    # User Repository (Doctrine auto-configuration)
    App\User\Domain\Repository\UserRepositoryInterface:
        alias: App\User\Infrastructure\Persistence\Doctrine\UserRepository

    # Book Repository (PostgreSQL)
    App\Book\Infrastructure\Persistence\Doctrine\BookRepository:
        arguments:
            $postgresBooks: '@doctrine.dbal.postgres_connection'

    App\Book\Domain\Repository\BookRepositoryInterface:
        alias: App\Book\Infrastructure\Persistence\Doctrine\BookRepository

    # Make controllers public for routing
    App\User\Infrastructure\Http\Controller\:
        resource: '../src/User/Infrastructure/Http/Controller/'
        tags: ['controller.service_arguments']

    App\Book\Infrastructure\Http\Controller\:
        resource: '../src/Book/Infrastructure/Http/Controller/'
        tags: ['controller.service_arguments']
